<?xml version="1.0"?>
<project name="joz-joz" default="no-default" basedir="..">
	
	<target name="no-default">
		<echo>This is a dummy target. No targets in this file is to be invoked directly.</echo>
	</target>

    <!-- NOTE WELL: This file is imported into the main build.xml file.
         It is not intended to work standalone.  -->

    <!-- ****************************************************************** -->
	
	<target name="build-indexer-zip" depends="build-Joz-jar">
		
		<delete dir="${stage.dir}/IndexCreator"/>
		<mkdir dir="${stage.dir}/IndexCreator"/>

		<copy todir="${stage.dir}/IndexCreator" file="${dist.dir}/joz.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/lucene-core-2.1.0.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/lucene-memory-2.1.0.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${caa.lib.dir}/caa.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${cma.lib.dir}/cma.jar"/>
	    <copy todir="${stage.dir}/IndexCreator" file="${cma.lib.dir}/jyaml-1.2.jar"/>
	    <copy todir="${stage.dir}/IndexCreator" file="${cma.lib.dir}/ibatis-2.3.0.677.jar"/>
	    <copy todir="${stage.dir}/IndexCreator" file="${utils.lib.dir}/utils.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/log4j-1.2.6.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/commons-codec-1.3.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/commons-httpclient-3.0-rc2.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/commons-logging.jar"/>
		
		<touch file="${stage.dir}/IndexCreator/createIndex.sh"/>

		<echo file="${stage.dir}/IndexCreator/createIndex.sh">#!/bin/sh</echo>
		<echo file="${stage.dir}/IndexCreator/createIndex.sh">java -Xms512m -Xmx1g -classpath joz.jar:lucene-core-2.1.0.jar:lucene-memory-2.1.0.jar:caa.jar:jyaml-1.2.jar:ibatis-2.3.0.677.jar:cma.jar:utils.jar:log4j-1.2.6.jar:commons-codec-1.3.jar:commons-httpclient-3.0-rc2.jar:commons-logging.jar com.tumri.joz.keywordServer.ProductIndex $@</echo>
		<chmod file="${stage.dir}/IndexCreator/createIndex.sh" perm="a+x"></chmod>

		<delete file="${stage.dir}/IndexCreator/IndexCreator.tar"/>

		<tar destfile="${stage.dir}/IndexCreator/IndexCreator.tar">
		    <tarfileset dir="${stage.dir}/IndexCreator">
			<include name="*.jar"/>
		    </tarfileset>
		    <tarfileset dir="${stage.dir}/IndexCreator" mode="755">
			<include name="*.sh"/>
		    </tarfileset>
		</tar>

		<gzip zipfile="${stage.dir}/IndexCreator/IndexCreator.tgz" src="${stage.dir}/IndexCreator/IndexCreator.tar"/>
		<delete file="${stage.dir}/IndexCreator/IndexCreator.tar"/>
		
	</target>
	
	
	<target name="build-data-generator-zip" depends="build-indexer-zip">
		<delete dir="${stage.dir}/DataGenerator"/>
		<mkdir dir="${stage.dir}/DataGenerator"/>
		
		<copy todir="${stage.dir}/DataGenerator" file="${stage.dir}/IndexCreator/IndexCreator.tgz"/>		
		<copy todir="${stage.dir}/DataGenerator" file="${root.dir}/scripts/jozFetchData.sh"/>

		<tar destfile="${stage.dir}/DataGenerator/JozDataGenerator.tar">
		    <tarfileset dir="${stage.dir}/DataGenerator">
				<include name="*.tgz"/>
		    </tarfileset>
		    <tarfileset dir="${stage.dir}/DataGenerator" mode="755">
			<include name="*.sh"/>
		    </tarfileset>
		</tar>

		<gzip zipfile="${stage.dir}/DataGenerator/JozDataGenerator.tgz" src="${stage.dir}/DataGenerator/JozDataGenerator.tar"/>
		<delete file="${stage.dir}/DataGenerator/JozDataGenerator.tar"/>

	</target>
	
    <target name="build-indexer-jar" depends="build-data-generator-zip">

		<move file="${stage.dir}/IndexCreator/IndexCreator.tgz" todir="${dist.dir}"/>

		<move file="${stage.dir}/DataGenerator/JozDataGenerator.tgz" todir="${dist.dir}"/>

    </target>

    <!-- ****************************************************************** -->

    <target name="build-Joz-jar" depends="init,version">

        <javac destdir="${classes.dir}"
               debug="on"
               optimize="on"
               srcdir="${src.dir}"
               includes="**/*.java"
	       excludes="com/tumri/joz/testsuite/*.java">
            <classpath refid="project.class.path"/>
            <compilerarg value="-Xlint:unchecked"/>
	    <compilerarg value="-Xlint:deprecation"/>
        </javac>

        <delete dir="${stage.dir}/Joz"/>
        <mkdir dir="${stage.dir}/Joz"/>

        <!-- copy so it gets put into our jar -->
        <copy file="${src.dir}/log4j.properties.template"
              todir="${stage.dir}/Joz"/>

        <jar destfile="${dist.dir}/joz.jar">
            <fileset dir="${classes.dir}"
		     includes="**/*.class"
		     excludes="com/tumri/joz/testsuite/*.class"/>
            <fileset dir="${stage.dir}/Joz"/>
			<!--  JMN - to include the *.version.properties file. -->
            <fileset dir="${dist.dir}/META-INF/"
            	includes="${version_properties_file_dest}" />
            <manifest>
                <attribute name="Main-Class" value="com.tumri.joz.keywordServer.ProductIndex"/>
            </manifest>
        </jar>

    </target>

    <!-- ****************************************************************** -->

    <target name="build-Joz-war" depends="build-Joz-jar">

	<war destfile="${dist.dir}/joz.war" 
		webxml="${src.dir}/webresources/WEB-INF/web.xml">
		<fileset dir="${src.dir}/webresources/">
			<exclude name="WEB-INF"/>
		</fileset>
		<!-- JMN - to include the *.version.properties file. -->
		<fileset dir="${dist.dir}/META-INF/">
			<include name="${version_properties_file_dest}"/>
		</fileset>
	    <lib dir="${dist.dir}" includes="joz.jar"/>
	    <lib dir="${ext.lib.dir}" includes="*.jar">
	    	<exclude name="log4j*.jar"/>
	    	<exclude name="servlet-api.jar"/>
        <exclude name="mysql-connector-java-3.1.14-bin.jar"/>        
      </lib>
	    <lib dir="${zini.lib.dir}" includes="zini.catalog.api.jar"/>
	    <lib dir="${utils.lib.dir}" includes="utils.jar"/>
	    <lib dir="${cma.lib.dir}" includes="cma.jar"/>
      <lib dir="${cma.lib.dir}" includes="jyaml-1.2.jar"/>
      <lib dir="${cma.lib.dir}" includes="ibatis-2.3.0.677.jar"/>
      <lib dir="${caa.lib.dir}" includes="caa.jar"/>
	</war>

    </target>

	<!-- ****************************************************************** -->		
	<!-- JMN - A target to generate product version information. -->
	<target name="version">
	    <property file="${root.dir}/build/joz_version.properties"/>
		
		<mkdir dir="${dist.dir}/META-INF/"/>
		<copy file="${top.root.dir}/build/${version_properties_file_src}" 
			tofile="${dist.dir}/META-INF/${version_properties_file_dest}"/>
		
	    <!-- JMN - To be implemented and utilized after 10/9/07.
		<manifest>
			<section name="common">
				<attribute name="Specification-Title" value="${product_name}"/>
				<attribute name="Specification-Vendor" value="${vendor}"/>
				<attribute name="Specification-Version" value="${major_number}.${minor_number}.${maintenance_number}"/>
				<attribute name="Implementation-Title" value="${product_name}"/>
				<attribute name="Implementation-Vendor" value="${vendor}"/>
				<attribute name="Implementation-Version" value="${version}"/>
			</section>
		</manifest>
		<metainf dir="${dist.dir}/META-INF/">
			<copy file="${top.root.dir}/build/${version_properties_file_src}" 
				tofile="${dist.dir}/META-INF/${version_properties_file_dest}"/>
			<include name="${version_properties_file_dest}"/>
		</metainf>
		-->
	</target>

</project>
