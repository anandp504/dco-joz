<?xml version="1.0"?>
<project name="joz-joz" default="no-default" basedir="..">

	<target name="no-default">
		<echo>This is a dummy target. No targets in this file is to be invoked directly.</echo>
	</target>

    <!-- NOTE WELL: This file is imported into the main build.xml file.
         It is not intended to work standalone.  -->

    <!-- ****************************************************************** -->
	
	<target name="build-indexer-zip" depends="build-Joz-jar">
		
		<delete dir="${stage.dir}/IndexCreator"/>
		<mkdir dir="${stage.dir}/IndexCreator"/>

		<copy todir="${stage.dir}/IndexCreator" file="${dist.dir}/joz.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/lucene-core-2.1.0.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/lucene-memory-2.1.0.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${caa.lib.dir}/caa.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${llc.lib.dir}/llc.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${cma.lib.dir}/${cma.lib.file}"/>
	    <!--<copy todir="${stage.dir}/IndexCreator" file="${cma.lib.dir}/jyaml-1.2.jar"/>-->
	    <!--<copy todir="${stage.dir}/IndexCreator" file="${cma.lib.dir}/ibatis-2.3.0.677.jar"/>-->
	    <copy todir="${stage.dir}/IndexCreator" file="${utils.lib.dir}/${utils.lib.file}"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/log4j-1.2.6.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/commons-codec-1.3.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/commons-httpclient-3.0-rc2.jar"/>
		<copy todir="${stage.dir}/IndexCreator" file="${ext.lib.dir}/commons-logging.jar"/>
		
		<touch file="${stage.dir}/IndexCreator/createIndex.sh"/>

		<echo file="${stage.dir}/IndexCreator/createIndex.sh">#!/bin/sh</echo>
		<echo file="${stage.dir}/IndexCreator/createIndex.sh">java -Xms512m -Xmx2g -classpath .:joz.jar:lucene-core-2.1.0.jar:lucene-memory-2.1.0.jar:caa.jar:${cma.lib.file}:${utils.lib.file}:log4j-1.2.6.jar:commons-codec-1.3.jar:commons-httpclient-3.0-rc2.jar:commons-logging.jar com.tumri.joz.keywordServer.ProductIndex $@</echo>
		<chmod file="${stage.dir}/IndexCreator/createIndex.sh" perm="a+x"></chmod>

        <touch file="${stage.dir}/IndexCreator/log4j.properties"/>
        <echo file="${stage.dir}/IndexCreator/log4j.properties">log4j.rootLogger=INFO,A1
log4j.appender.A1=org.apache.log4j.ConsoleAppender
log4j.appender.A1.layout=org.apache.log4j.PatternLayout
log4j.appender.A1.layout.ConversionPattern=[%t] %-4r %-5p (%F:%L) - %m%n</echo>

        <delete file="${stage.dir}/IndexCreator/IndexCreator.tar"/>

		<tar destfile="${stage.dir}/IndexCreator/IndexCreator.tar">
		    <tarfileset dir="${stage.dir}/IndexCreator">
			<include name="*.jar"/>
		    </tarfileset>
		    <tarfileset dir="${stage.dir}/IndexCreator" mode="755">
			<include name="*.sh"/>
            <include name="*.properties"/>
            </tarfileset>
		</tar>

		<gzip zipfile="${stage.dir}/IndexCreator/IndexCreator.tgz" src="${stage.dir}/IndexCreator/IndexCreator.tar"/>
		<delete file="${stage.dir}/IndexCreator/IndexCreator.tar"/>
		
	</target>
	
	
	<target name="build-data-generator-zip" depends="build-indexer-zip">
		<delete dir="${stage.dir}/DataGenerator"/>
		<mkdir dir="${stage.dir}/DataGenerator"/>
		
		<copy todir="${stage.dir}/DataGenerator" file="${stage.dir}/IndexCreator/IndexCreator.tgz"/>		
		<copy todir="${stage.dir}/DataGenerator" file="${root.dir}/scripts/jozFetchData.sh"/>

		<tar destfile="${stage.dir}/DataGenerator/JozDataGenerator.tar">
		    <tarfileset dir="${stage.dir}/DataGenerator">
				<include name="*.tgz"/>
		    </tarfileset>
		    <tarfileset dir="${stage.dir}/DataGenerator" mode="755">
			<include name="*.sh"/>
		    </tarfileset>
		</tar>

		<gzip zipfile="${stage.dir}/DataGenerator/JozDataGenerator.tgz" src="${stage.dir}/DataGenerator/JozDataGenerator.tar"/>
		<delete file="${stage.dir}/DataGenerator/JozDataGenerator.tar"/>

	</target>
	
    <target name="build-indexer-jar" depends="build-data-generator-zip">

		<move file="${stage.dir}/IndexCreator/IndexCreator.tgz" todir="${dist.dir}"/>

		<move file="${stage.dir}/DataGenerator/JozDataGenerator.tgz" todir="${dist.dir}"/>

    </target>

    <target name="build-TestListingGenerator" depends="build-indexer-zip">
        <delete dir="${stage.dir}/TestListingGenerator"/>
        <mkdir dir="${stage.dir}/TestListingGenerator"/>

        <copy todir="${stage.dir}/TestListingGenerator" file="${dist.dir}/IndexCreator.tgz"/>
        <javac destdir="${classes.dir}"
               debug="on"
               optimize="on"
               srcdir="${test.dir}"
               includes="**/ListingTestDataProvider.java">
            <classpath refid="project.class.path"/>
            <classpath><pathelement location="${dist.dir}/joz.jar"/></classpath>
            <compilerarg value="-Xlint:unchecked"/>
	    <compilerarg value="-Xlint:deprecation"/>
        </javac>

        <jar destfile="${stage.dir}/TestListingGenerator/testListingGen.jar">
            <fileset dir="${classes.dir}"
		     includes="**/*.class"/>
            <fileset dir="${stage.dir}/TestListingGenerator"/>
            <manifest>
                <attribute name="Main-Class" value="com.tumri.joz.util.ListingTestDataProvider"/>
            </manifest>
        </jar>

        <copy todir="${stage.dir}/TestListingGenerator" file="${caa.lib.dir}/caa.jar"/>
        <copy todir="${stage.dir}/TestListingGenerator" file="${utils.lib.dir}/${utils.lib.file}"/>
        <copy todir="${stage.dir}/TestListingGenerator">
            <fileset dir="${test.dir}/data" includes="*.*"/>
        </copy>
        <touch file="${stage.dir}/TestListingGenerator/createListing.sh"/>

        <echo file="${stage.dir}/TestListingGenerator/createListing.sh">#!/bin/sh</echo>
        <echo file="${stage.dir}/TestListingGenerator/createListing.sh">java -Xms512m -Xmx1g -classpath .:caa.jar:${utils.lib.file}:testListingGen.jar com.tumri.joz.util.ListingTestDataProvider $@</echo>
        <chmod file="${stage.dir}/TestListingGenerator/createListing.sh" perm="a+x"></chmod>

        <tar destfile="${stage.dir}/TestListingGenerator/TestListingGenerator.tar">
            <tarfileset dir="${stage.dir}/TestListingGenerator">
                 <exclude name="*.sh"/>
            </tarfileset>
            <tarfileset dir="${stage.dir}/TestListingGenerator" mode="755">
                <include name="*.sh"/>
            </tarfileset>

        </tar>

        <gzip zipfile="${stage.dir}/TestListingGenerator/TestListingGenerator.tgz" src="${stage.dir}/TestListingGenerator/TestListingGenerator.tar"/>
        <delete file="${stage.dir}/TestListingGenerator/TestListingGenerator.tar"/>

        <move file="${stage.dir}/TestListingGenerator/TestListingGenerator.tgz" todir="${dist.dir}"/>

    </target>

    <path id="jozclient.class.path">
        <fileset dir="${ext.lib.dir}">
            <include name="*.jar"/>
        </fileset>
	<fileset dir="${utils.lib.dir}">
            <include name="${utils.lib.file}"/>
	</fileset>
	<fileset dir="${cma.lib.dir}">
            <include name="${cma.lib.file}"/>
	</fileset>
    </path>

    <target name="build-jozclient" depends="init">
        <delete dir="${stage.dir}/jozclient"/>
        <mkdir dir="${stage.dir}/jozclient"/>

        <javac destdir="${classes.dir}"
               debug="on"
               optimize="on"
               srcdir="${src.dir}"
               includes="com/tumri/joz/client/**,com/tumri/joz/server/domain/**">
            <classpath refid="jozclient.class.path"/>
            <compilerarg value="-Xlint:unchecked"/>
	    <compilerarg value="-Xlint:deprecation"/>
        </javac>

        <jar destfile="${stage.dir}/jozclient/jozclient.jar">
            <fileset dir="${classes.dir}"
		     includes="com/tumri/joz/client/**,com/tumri/joz/server/domain/**"/>
        </jar>

        <move file="${stage.dir}/jozclient/jozclient.jar" todir="${dist.dir}"/>
    </target>
	<target name="java-doc" depends="">
		<delete dir="${dist.dir}/javadocs"/>
		<mkdir dir="${dist.dir}/javadocs"/>
		<javadoc destdir="${dist.dir}/javadocs"
                 classpathref="project.class.path" author="false" version="true" use="true"
                 windowtitle="Joz Client API">
            <classpath refid="project.class.path"/>
            <packageset dir="${src.dir}" defaultexcludes="yes">
            <include name="com/tumri/joz/**"/>
            </packageset>
            <doctitle><![CDATA[<h1>Joz API</h1>]]></doctitle>
            <bottom>
            <![CDATA[<i>Copyright &#169; 2007 Tumri Inc. All Rights Reserved.</i>]]>
            </bottom>
		</javadoc>
	</target>

    <!-- ****************************************************************** -->

    <target name="build-Joz-jar" depends="init,version">

        <javac destdir="${classes.dir}"
               debug="on"
               optimize="on"
               srcdir="${src.dir}"
               includes="**/*.java"
	        excludes="com/tumri/joz/testsuite/*.java">
            <classpath refid="project.class.path"/>
            <compilerarg value="-Xlint:unchecked"/>
	    <compilerarg value="-Xlint:deprecation"/>
        </javac>

        <delete dir="${stage.dir}/Joz"/>
        <mkdir dir="${stage.dir}/Joz"/>

        <!-- copy so it gets put into our jar -->
        <copy file="${src.dir}/log4j.properties.template"
              todir="${stage.dir}/Joz"/>

        <jar destfile="${dist.dir}/joz.jar">
            <fileset dir="${classes.dir}"
		     includes="**/*.class"
		     excludes="com/tumri/joz/testsuite/*.class"/>
            <fileset dir="${stage.dir}/Joz"/>
			<!-- JMN - Include both *_version.properties and label file. -->
			<fileset dir="${dist.dir}" includes="${version_properties_file_dest}" />
			<fileset dir="${dist.dir}" includes="${label_file}" />
            <fileset dir="${src.dir}/conf">
                <include name="jozindex.properties"/>
                <include name="luceneindex.properties"/>
                <include name="QueryHandlers.properties"/>
            </fileset>
            <fileset dir="${ext.data.dir}">
                <include name="zipcodedb.xml"/>
            </fileset>
            <manifest>
                <attribute name="Main-Class" value="com.tumri.joz.keywordServer.ProductIndex"/>
            </manifest>
        </jar>

    </target>

    <!-- ****************************************************************** -->

    <target name="build-Joz-war" depends="build-Joz-jar">

		<war destfile="${dist.dir}/joz.war" 
			webxml="${src.dir}/webresources/WEB-INF/web.xml">
			<fileset dir="${src.dir}/webresources/">
				<exclude name="WEB-INF"/>
			</fileset>
	    	<lib dir="${dist.dir}" includes="joz.jar"/>
	    	<lib dir="${ext.lib.dir}" includes="*.jar">
	    		<exclude name="log4j*.jar"/>
	    		<exclude name="servlet-api.jar"/>
				<exclude name="mysql-connector-java-3.1.14-bin.jar"/>        
      		</lib>
	    	<lib dir="${utils.lib.dir}" includes="${utils.lib.file}"/>
		    <lib dir="${cma.lib.dir}" includes="${cma.lib.file}"/>
			<lib dir="${jcl.lib.dir}" includes="${jcl.lib.file}"/>
		      <!--<lib dir="${cma.lib.dir}" includes="jyaml-1.2.jar"/>-->
      		<!--<lib dir="${cma.lib.dir}" includes="ibatis-2.3.0.677.jar"/>-->
      		<lib dir="${caa.lib.dir}" includes="caa.jar"/>
      		<lib dir="${llc.lib.dir}" includes="llc.jar"/>
			<!-- JMN - Include both *_version.properties and label file. -->
			<classes dir="${dist.dir}" includes="${version_properties_file_dest}" />
			<fileset dir="${dist.dir}" includes="${label_file}" />
		</war>

    </target>

	<!-- ****************************************************************** -->		
	<!-- JMN - A target to generate product version information. -->
	<target name="version">
		<property file="${root.dir}/build/joz_version.properties" />
		<!-- Copy *_version.properties over and create a label file. -->
		<copy
			file="${top.root.dir}/build/${version_properties_file_src}"
			tofile="${dist.dir}/${version_properties_file_dest}" />
		<touch file="${dist.dir}/${label_file}" />
		<echo file="${dist.dir}/${label_file}"># code_label=${code_label}${line.separator} </echo>

		<!-- Replace all variables in the *_version.properties with actual values. -->
		<replace file="${dist.dir}/${version_properties_file_dest}" > 
			<replacefilter token="{" value="@" />
			<replacefilter token="}" value="@" />
		</replace>
		<replace file="${dist.dir}/${version_properties_file_dest}" >			
			<replacefilter token="$@major_number@" value="${major_number}" />
			<replacefilter token="$@minor_number@" value="${minor_number}" />
			<replacefilter token="$@maintenance_number@" value="${maintenance_number}" />
			<replacefilter token="$@build_number@" value="${build_number}" />
			<replacefilter token="$@release_id@" value="${release_id}" />
			<replacefilter token="$@release_candidate@" value="${release_candidate}" />		
			<replacefilter token="$@code_label@" value="${code_label}"	/>	
		</replace>
					
		<!-- JMN - To be implemented and utilized in the future.
			<manifest>
			<section name="common">
			<attribute name="Specification-Title" value="${product_name}"/>
			<attribute name="Specification-Vendor" value="${vendor}"/>
			<attribute name="Specification-Version" value="${major_number}.${minor_number}.${maintenance_number}"/>
			<attribute name="Implementation-Title" value="${product_name}"/>
			<attribute name="Implementation-Vendor" value="${vendor}"/>
			<attribute name="Implementation-Version" value="${version}"/>
			</section>
			</manifest>
			<metainf dir="${dist.dir}/META-INF/">
			<copy file="${top.root.dir}/build/${version_properties_file_src}" 
			tofile="${dist.dir}/META-INF/${version_properties_file_dest}"/>
			<include name="${version_properties_file_dest}"/>
			</metainf>
		-->
	</target>

</project>
